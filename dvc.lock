schema: '2.0'
stages:
  data:
    cmd: docker run --rm -it --gpus all -v $(pwd):/kaimahi/cose -w /kaimahi/cose -u
      1000:1000 docker.dragonfly.co.nz/cose python3 data_scripts/didi_json_to_tfrecords.py
      --data_dir data --log_level INFO
    deps:
    - path: data/didi_wo_text/diagrams_wo_text_20200131.ndjson
      md5: a5c1b9782278ea51241ad266c9257796
      size: 1040887970
    outs:
    - path: data/didi_wo_text/test
      md5: 3f4941356b782ff9beac16691665ed46.dir
      size: 104895429
      nfiles: 10
    - path: data/didi_wo_text/training
      md5: 8eaa1102c947799c99da6b90d51c87d1.dir
      size: 738667433
      nfiles: 10
    - path: data/didi_wo_text/validation
      md5: 592d604903ca42ff204bcdbf1f8fbce7.dir
      size: 126347027
      nfiles: 10
  calculate_statistics:
    cmd: docker run --rm -it --gpus all -v $(pwd):/kaimahi/cose -w /kaimahi/cose -u
      1000:1000 docker.dragonfly.co.nz/cose python3 data_scripts/calculate_data_statistics.py
      --data_dir data --log_level INFO
    deps:
    - path: data/didi_wo_text/test
      md5: 3f4941356b782ff9beac16691665ed46.dir
      size: 104895429
      nfiles: 10
    - path: data/didi_wo_text/training
      md5: 8eaa1102c947799c99da6b90d51c87d1.dir
      size: 738667433
      nfiles: 10
    - path: data/didi_wo_text/validation
      md5: 592d604903ca42ff204bcdbf1f8fbce7.dir
      size: 126347027
      nfiles: 10
    outs:
    - path: data/didi_wo_text/didi_wo_text-stats-origin_abs_pos.npy
      md5: aa875621bf5ea9c75cac1a1a2fdcf32b
      size: 899
  train_model:
    cmd: docker run --rm -it --gpus all -v $(pwd):/kaimahi/cose -w /kaimahi/cose -u
      1000:1000 docker.dragonfly.co.nz/cose python3 ink_training_eager_predictive.py  --experiment_id
      $(date +%s) --data_dir data --experiment_dir experiments --eval_dir eval --gt_targets
      --use_start_pos --num_pred_inputs 32 --stop_predictive_grad --pred_input_type
      hybrid --stroke_loss nll_gmm --n_t_samples 4 --batch_size 128 --affine_prob
      0.3 --resampling_factor 2 --scale_factor 0 --grad_clip_norm 1 --encoder_model
      transformer --transformer_scale --transformer_pos_encoding --transformer_layers
      6 --transformer_heads 4 --transformer_dmodel 64 --transformer_hidden_units 256
      --transformer_dropout 0.0 --latent_units 8 --decoder_model t_emb --decoder_dropout
      0.0 --decoder_layers 4 --decoder_hidden_units 512,512,512,512 --predictive_model
      transformer --learning_rate_type transformer --p_transformer_layers 6 --p_transformer_heads
      4 --p_transformer_dmodel 64 --p_transformer_hidden_units 256 --p_transformer_dropout
      0.0 --p_transformer_scale --embedding_loss nll_gmm --embedding_gmm_components
      10 --loss_predicted_embedding --loss_reconstructed_ink --position_model transformer
      --data_name didi_wo_text --metadata_type position --disable_pen_loss --mask_encoder_pen
    deps:
    - path: data/didi_wo_text/didi_wo_text-stats-origin_abs_pos.npy
      md5: aa875621bf5ea9c75cac1a1a2fdcf32b
      size: 899
    - path: data/didi_wo_text/test
      md5: 3f4941356b782ff9beac16691665ed46.dir
      size: 104895429
      nfiles: 10
    - path: data/didi_wo_text/training
      md5: 8eaa1102c947799c99da6b90d51c87d1.dir
      size: 738667433
      nfiles: 10
    - path: data/didi_wo_text/validation
      md5: 592d604903ca42ff204bcdbf1f8fbce7.dir
      size: 126347027
      nfiles: 10
